{% extends "base.html" %}

{% block head %}
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script type="text/javascript">
    const mergeObjects = (first, second) => ({ ...first, ...second });
    const filters = {};

    $(document).ready(function () {
        $('input[type="checkbox"]').on('change', function () {
            if (!$(this).is(':checked')) { // check if the input is unchecked
                var filterName = $(this).attr('name');
                var filterValue = $(this).val();
                var index = filters[filterName].indexOf(filterValue);
                if (index !== -1) { // check if the filterValue exists in the array
                    filters[filterName].splice(index, 1); // remove the filterValue from the array
                    if (filters[filterName].length === 0) {
                        delete filters[filterName]; // remove the filterName property if the array is empty
                    }
                }
            } else {
                $('input[type="checkbox"]:checked').each(function () {
                    var filterName = $(this).attr('name');
                    var filterValue = $(this).val();
                    if (filters[filterName]) {
                        if (filters[filterName].indexOf(filterValue) == -1) {
                            filters[filterName].push(filterValue);
                        }
                    } else {
                        filters[filterName] = [filterValue];
                    }
                });
            }

            $.ajax({
                url: '/issues_table',
                data: JSON.stringify(filters),
                type: 'POST',
                contentType: 'application/json;charset=UTF-8',
                success: function (res) {
                    if (res.data.redirect) {
                        //window.location.href = res.data.redirect
                        window.history.pushState({}, "", res.data.redirect);
                        $('#issue-items').html(res.data.items);
                    }
                }
            });
        });

        $('#search_text').keyup(function () {
            var search = $(this).val();

            $('input[type="checkbox"]:checked').each(function () {
                var filterName = $(this).attr('name');
                var filterValue = $(this).val();
                if (filters[filterName]) {
                    if (filters[filterName].indexOf(filterValue) == -1) {
                        filters[filterName].push(filterValue);
                    }
                } else {
                    filters[filterName] = [filterValue];
                }
            });

            if (search != '') {
                filters['keyword'] = [search];
            } else {
                delete filters.keyword
            }
            $.ajax({
                url: "/issues_table",
                method: "POST",
                data: JSON.stringify(filters),
                contentType: 'application/json;charset=UTF-8',
                success: function (res) {
                    if (res.data.redirect) {
                        //window.location.href = res.data.redirect
                        window.history.pushState({}, "", res.data.redirect);
                        $('#issue-items').html(res.data.items);
                    }
                }
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="container">{% include 'filters_bar.html' %}</div>
    <div class="container">
        <div class="container" id="issue-items">{% include 'issue_card.html'%}</div>
    </div>
</div>
{% endblock %}